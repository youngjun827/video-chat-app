{"ast":null,"code":"import _toConsumableArray from\"/Users/youngjun827/dev/discord-app/discord-frontend/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import store from\"../store/store\";import{setLocalStream,setRemoteStreams}from\"../store/actions/roomActions\";import Peer from\"simple-peer\";import*as socketConnection from\"./socketConnection\";var getConfiguration=function getConfiguration(){var turnIceServers=null;if(turnIceServers){// TODO use TURN server credentials\n}else{console.warn(\"Using only STUN server\");return{iceServers:[{urls:\"stun:stun.l.google.com:19302\"}]};}};var onlyAudioConstraints={audio:true,video:false};var defaultConstraints={video:true,audio:true};export var getLocalStreamPreview=function getLocalStreamPreview(){var onlyAudio=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;var callbackFunc=arguments.length>1?arguments[1]:undefined;var constraints=onlyAudio?onlyAudioConstraints:defaultConstraints;navigator.mediaDevices.getUserMedia(constraints).then(function(stream){store.dispatch(setLocalStream(stream));callbackFunc();}).catch(function(err){console.log(err);console.log(\"Cannot get an access to local stream\");});};var peers={};export var prepareNewPeerConnection=function prepareNewPeerConnection(connUserSocketId,isInitiator){var localStream=store.getState().room.localStream;if(isInitiator){console.log(\"preparing new peer connection as initiator\");}else{console.log(\"preparing new peer connection as not initiator\");}peers[connUserSocketId]=new Peer({initiator:isInitiator,config:getConfiguration(),stream:localStream});peers[connUserSocketId].on(\"signal\",function(data){var signalData={signal:data,connUserSocketId:connUserSocketId};socketConnection.signalPeerData(signalData);});peers[connUserSocketId].on(\"stream\",function(remoteStream){// TODO\n// add new remote stream to our server store\nconsole.log(\"remote stream came from other user\");console.log(\"direct connection has been established\");remoteStream.connUserSocketId=connUserSocketId;addNewRemoteStream(remoteStream);});};export var handleSignalingData=function handleSignalingData(data){var connUserSocketId=data.connUserSocketId,signal=data.signal;if(peers[connUserSocketId]){peers[connUserSocketId].signal(signal);}};var addNewRemoteStream=function addNewRemoteStream(remoteStream){var remoteStreams=store.getState().room.remoteStreams;var newRemoteStreams=[].concat(_toConsumableArray(remoteStreams),[remoteStream]);store.dispatch(setRemoteStreams(newRemoteStreams));};export var closeAllConnections=function closeAllConnections(){Object.entries(peers).forEach(function(mappedObject){var connUserSocketId=mappedObject[0];if(peers[connUserSocketId]){peers[connUserSocketId].destroy();delete peers[connUserSocketId];}});};export var handleParticipantLeftRoom=function handleParticipantLeftRoom(data){var connUserSocketId=data.connUserSocketId;if(peers[connUserSocketId]){peers[connUserSocketId].destroy();delete peers[connUserSocketId];}var remoteStreams=store.getState().room.remoteStreams;var newRemoteStreams=remoteStreams.filter(function(remoteStream){return remoteStream.connUserSocketId!==connUserSocketId;});store.dispatch(setRemoteStreams(newRemoteStreams));};export var switchOutgoingTracks=function switchOutgoingTracks(stream){for(var socket_id in peers){for(var index in peers[socket_id].streams[0].getTracks()){for(var index2 in stream.getTracks()){if(peers[socket_id].streams[0].getTracks()[index].kind===stream.getTracks()[index2].kind){peers[socket_id].replaceTrack(peers[socket_id].streams[0].getTracks()[index],stream.getTracks()[index2],peers[socket_id].streams[0]);break;}}}}};","map":{"version":3,"names":["store","setLocalStream","setRemoteStreams","Peer","socketConnection","getConfiguration","turnIceServers","console","warn","iceServers","urls","onlyAudioConstraints","audio","video","defaultConstraints","getLocalStreamPreview","onlyAudio","callbackFunc","constraints","navigator","mediaDevices","getUserMedia","then","stream","dispatch","catch","err","log","peers","prepareNewPeerConnection","connUserSocketId","isInitiator","localStream","getState","room","initiator","config","on","data","signalData","signal","signalPeerData","remoteStream","addNewRemoteStream","handleSignalingData","remoteStreams","newRemoteStreams","closeAllConnections","Object","entries","forEach","mappedObject","destroy","handleParticipantLeftRoom","filter","switchOutgoingTracks","socket_id","index","streams","getTracks","index2","kind","replaceTrack"],"sources":["/Users/youngjun827/dev/discord-app/discord-frontend/src/realtimeCommunication/webRTCHandler.js"],"sourcesContent":["import store from \"../store/store\";\r\nimport { setLocalStream, setRemoteStreams } from \"../store/actions/roomActions\";\r\nimport Peer from \"simple-peer\";\r\nimport * as socketConnection from \"./socketConnection\";\r\n\r\nconst getConfiguration = () => {\r\n  const turnIceServers = null;\r\n\r\n  if (turnIceServers) {\r\n    // TODO use TURN server credentials\r\n  } else {\r\n    console.warn(\"Using only STUN server\");\r\n    return {\r\n      iceServers: [\r\n        {\r\n          urls: \"stun:stun.l.google.com:19302\",\r\n        },\r\n      ],\r\n    };\r\n  }\r\n};\r\n\r\nconst onlyAudioConstraints = {\r\n  audio: true,\r\n  video: false,\r\n};\r\n\r\nconst defaultConstraints = {\r\n  video: true,\r\n  audio: true,\r\n};\r\n\r\nexport const getLocalStreamPreview = (onlyAudio = false, callbackFunc) => {\r\n  const constraints = onlyAudio ? onlyAudioConstraints : defaultConstraints;\r\n\r\n  navigator.mediaDevices\r\n    .getUserMedia(constraints)\r\n    .then((stream) => {\r\n      store.dispatch(setLocalStream(stream));\r\n      callbackFunc();\r\n    })\r\n    .catch((err) => {\r\n      console.log(err);\r\n      console.log(\"Cannot get an access to local stream\");\r\n    });\r\n};\r\n\r\nlet peers = {};\r\n\r\nexport const prepareNewPeerConnection = (connUserSocketId, isInitiator) => {\r\n  const localStream = store.getState().room.localStream;\r\n\r\n  if (isInitiator) {\r\n    console.log(\"preparing new peer connection as initiator\");\r\n  } else {\r\n    console.log(\"preparing new peer connection as not initiator\");\r\n  }\r\n\r\n  peers[connUserSocketId] = new Peer({\r\n    initiator: isInitiator,\r\n    config: getConfiguration(),\r\n    stream: localStream,\r\n  });\r\n\r\n  peers[connUserSocketId].on(\"signal\", (data) => {\r\n    const signalData = {\r\n      signal: data,\r\n      connUserSocketId: connUserSocketId,\r\n    };\r\n\r\n    socketConnection.signalPeerData(signalData);\r\n  });\r\n\r\n  peers[connUserSocketId].on(\"stream\", (remoteStream) => {\r\n    // TODO\r\n    // add new remote stream to our server store\r\n    console.log(\"remote stream came from other user\");\r\n    console.log(\"direct connection has been established\");\r\n    remoteStream.connUserSocketId = connUserSocketId;\r\n    addNewRemoteStream(remoteStream);\r\n  });\r\n};\r\n\r\nexport const handleSignalingData = (data) => {\r\n  const { connUserSocketId, signal } = data;\r\n\r\n  if (peers[connUserSocketId]) {\r\n    peers[connUserSocketId].signal(signal);\r\n  }\r\n};\r\n\r\nconst addNewRemoteStream = (remoteStream) => {\r\n  const remoteStreams = store.getState().room.remoteStreams;\r\n  const newRemoteStreams = [...remoteStreams, remoteStream];\r\n\r\n  store.dispatch(setRemoteStreams(newRemoteStreams));\r\n};\r\n\r\nexport const closeAllConnections = () => {\r\n  Object.entries(peers).forEach((mappedObject) => {\r\n    const connUserSocketId = mappedObject[0];\r\n    if (peers[connUserSocketId]) {\r\n      peers[connUserSocketId].destroy();\r\n      delete peers[connUserSocketId];\r\n    }\r\n  });\r\n};\r\n\r\nexport const handleParticipantLeftRoom = (data) => {\r\n  const { connUserSocketId } = data;\r\n\r\n  if (peers[connUserSocketId]) {\r\n    peers[connUserSocketId].destroy();\r\n    delete peers[connUserSocketId];\r\n  }\r\n\r\n  const remoteStreams = store.getState().room.remoteStreams;\r\n\r\n  const newRemoteStreams = remoteStreams.filter(\r\n    (remoteStream) => remoteStream.connUserSocketId !== connUserSocketId\r\n  );\r\n\r\n  store.dispatch(setRemoteStreams(newRemoteStreams));\r\n};\r\n\r\nexport const switchOutgoingTracks = (stream) => {\r\n  for (let socket_id in peers) {\r\n    for (let index in peers[socket_id].streams[0].getTracks()) {\r\n      for (let index2 in stream.getTracks()) {\r\n        if (\r\n          peers[socket_id].streams[0].getTracks()[index].kind ===\r\n          stream.getTracks()[index2].kind\r\n        ) {\r\n          peers[socket_id].replaceTrack(\r\n            peers[socket_id].streams[0].getTracks()[index],\r\n            stream.getTracks()[index2],\r\n            peers[socket_id].streams[0]\r\n          );\r\n          break;\r\n        }\r\n      }\r\n    }\r\n  }\r\n};\r\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}